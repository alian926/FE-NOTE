# v8是如何执行javascript的

## 什么是v8?

v8是一个javascript引擎,核心功能是执行javascript代码.

核心流程分为编译和执行两步.
首先将**js代码***转换*为**低级中间代码**或者**机器代码**,然后再*执行*转换后的代码并*输出*执行结果.

v8可以当做一个虚拟机,有自己的CPU,堆栈,寄存器等还有自己的一套指令系统.

## 高级代码为什么需要先编译再执行?

不同的CPU有着不同的指令集(只识别二级制代码指令),高级语言屏蔽了计算机架构的细节,适应多种不同CPU架构.

通常有两种方式来执行 处理器不能直接识别的高级代码.
1. 解释执行. 先将输入的**源代码**通过*解析器*编译成**中间代码**,之后直接使用*解释器*解释执行中间代码,然后**直接输出结果**. 
   即:  源代码 --解析器-> 中间代码 --解释器-> 输出结果
2. 编译执行. 先结**源代码**转换成**中间代码**,然后编译器将中间代码翻译成**机器代码**(通常是二进制文件形式,可以通过虚拟器将其存在内存中),执行程序时**直接执行二进制文件**
   即:  源代码 --解析器-> 中间代码 --编译器-> 机器代码 --执行-> 输出结果

## v8如何执行js的?
v8是js虚拟机的一种. 混合编译执行和解释执行两种手段,即 JIT(Just In Time)技术, 即时编译.

v8启动执行js前,需要准备一些基础环境,包括: 堆栈空间, 全局执行上下文,全局作用域,消息循环系统, 内置函数等.
* js全局执行上下文包含了执行过程中的全局信息,比如一些内置函数,全局变量等
* 全局作用域包含一些全局变量,在执行过程中的数据都需要存放在内存中
* v8采用了经典的堆和栈的内存管理模式
* 消息循环包含消息驱动器和消息队列,不断接受消息并决策如何处理消息

v8接收到**源代码字符串**,并不能直接理解其含义,首先需要**结构化**(指信息经过分析后可分解成多个互相关联的组成部分)这段字符串,生成抽象语法树**AST**,AST是v8便于理解的结构.
生成AST的同时,v8还会生成相关的**作用域**,作用域中*存放相关变量*

有了AST和作用域就可以生成**字节码**,它是介于AST和机器代码的中间代码.解释器可以直接执行字节码,或者通过编译器将其翻译为二进制的机器代码再执行.

如果某段代码被重复多次执行,会被标记为**热点代码**.此时v8会将此字节码丢给*优化编译器*,优化编译器在后台将其编译为二进制代码,并再次进行优化,后面再执行此代码时,优先选择**优化后的二进制代码**.
经过优化编译器优化的代码只能针对某种固定的结构,一旦*对象结构被动态修改*,优化代码会无效,需要执行**反优化操作**,下次执行时会退回到*解释器解释执行*.

解释执行和编译执行都有各自的优缺点，解释执行启动速度快，但是执行时速度慢，而编译执行启动速度慢，但是执行速度快。


